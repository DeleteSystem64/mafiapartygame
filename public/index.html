<!DOCTYPE html>
<html>
<style>
  
html, body 
{
  height: 100dvh;
  width: 100dvw;
  overflow: hidden;
  font-family: "Oswald", sans-serif;
}

body
{
  color:white;
  font-family: "Oswald", sans-serif;
  background-image: url(carti.png);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  max-height: 100vh;
  overflow: hidden;
  margin: 0;
  padding: 0;
  
  background-color: black;
  display:flex;
  flex-direction: column;
  justify-content: space-around;
  align-items: center;
}
.header
{
  width:100%;
  display:flex;
  flex-direction: column;
  align-items: center;
  
  flex-grow: 0.5;
  justify-content: center;
  font-size: clamp(1rem, 10vh, 10rem);
  color:red;
}

.main
{
  height: 70%;
  width: 100%;
  background-color: rgb(27, 27, 27);
  flex-grow: 2;
  display: flex;
  flex-direction: column;
  justify-content: space-around;
  align-items: center;
}

.section
{
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  width: 80%;
  height: 30%;
  
}

input
{
  font-size: clamp(1rem, 2.2vh, 8rem);
  
  display: flex;
  height: 20%;
  max-width: 50vh;
  width: clamp(5rem, 600px, 100rem);
}

#joinButton
{
  margin-top: 20px;
  font-size: clamp(1rem, 5vh, 5rem);
  display: flex;
  height:30%;
  width: 30%;
  flex-direction: column;
  
  justify-content: center;
  align-items: center;
  justify-self: flex-end;
  font-family: "Oswald", sans-serif;
}
button
{
  background-color: black;
  color:red;
}
#createButton
{
  font-size: clamp(1rem, 5vh, 5rem);
  display: flex;
  height:50%;
  width: 80%;
  max-width: 50vw;
  flex-direction: column;
  
  justify-content: center;
  align-items: center;
  justify-self: flex-end;
  font-family: "Oswald", sans-serif;
}

h1
{
  margin:0;
  font-size: clamp(1rem, 9vh, 9rem);
}

</style>
<head>
  <title>Create/Join Game</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@200..700&display=swap" rel="stylesheet">
</head>


<body id="body">
  <div class ="header">MAFIA</div>
  <div class ="main">
    <div class="section">
      <h1>YOUR NAME</h1>
      <input type="text" id="nameInput" placeholder="YOUR NAME"/>
    </div>
    <div class="section">
      <h1>JOIN A GAME</h1>
      <input type="text" id="codeInput" placeholder="ENTER 4-LETTER CODE"/>
      <button id="joinButton">JOIN</button>
    </div>
    
    <div class = "section"><h1>OR</h1><button id="createButton">CREATE A NEW GAME</button></div>

    
  </div>
  
  
  <script>
    const ip = "ws://localhost:3000";
    const ws = new WebSocket(ip);
    const codeInput = document.getElementById('codeInput');
    const nameInput = document.getElementById('nameInput');
    const createGameButton = document.getElementById('createButton');
    const joinGameButton = document.getElementById('joinButton');

   // Add event listener to restrict input to alphabets only
        codeInput.addEventListener('input', function(event) {
            // Allow only alphabetic characters and force uppercase
            let value = event.target.value;

            // Replace any non-alphabetic character with an empty string
            value = value.replace(/[^A-Za-z]/g, '');

            // Set the value back to the input, making sure it's uppercase
            event.target.value = value.toUpperCase();
        });  
    ws.onmessage = (event) => 
    {
      const data = JSON.parse(event.data);
      if(data.error)
      {
        alert(data.error);
        return; 
      }

      if(!data.type)
      {
        alert("Could not parse JSON for type of message.");
        return;
      }
      
      if(data.type === "join_success")
      {
        let gameID = data.gameID.toUpperCase();
        let playerID = data.playerID;
        localStorage.setItem("playerID", playerID);
        localStorage.setItem("gameID", gameID);
        window.location.href = "lobby.html?gameID=" + gameID;
      }
      else if(data.type === "create_success")
      {
        let msg = JSON.stringify(
          {
            type:"join_game",
            gameCode:data.payload,
            playerName: nameInput.value
          });

          
        ws.send(msg);
      }
      else
      {
        alert(data.type);
      }
    };
    ws.onclose = function(event) 
    {
      alert("Connection was closed. Please refresh or try again.");
      console.log(event);
    };
    ws.onerror = function(event) 
    {
      alert("There was a problem with the WebSocket connection.");
      console.log(event);
    };
    function createGame() 
    {
      if(nameInput.value === "")
      { 
        alert('Please enter a name first.'); 
        return;
      }
      const name = nameInput.value;
      if(name.replace(/\s/g, '') === "")
      {
        alert("Your name needs at least 1 non-whitespace character.");
        return;
      }
      let bleh = JSON.stringify({type:"create_game"});
      
      if (ws.readyState === WebSocket.OPEN) 
      {
        ws.send(bleh);
      } 
      else 
      {
        alert("Connection is not open. Please refresh or try again later.");
      }
      
      
    }

    function joinGame()
    {
      const gameCode = codeInput.value.toUpperCase();
      
      if(nameInput.value === "")
      {
        alert('Please enter a name first.'); 
        return;
      } 
      const name = nameInput.value;
      if(name.replace(/\s/g, '') === "")
      {
        alert("Your name needs at least 1 non-whitespace character.");
        return;
      }
      let data = 
      {
        type:"join_game",
        gameCode:gameCode,
        playerName:name
      };
      if(localStorage.getItem("playerID") !== null)
      {
          data.playerID = localStorage.getItem("playerID");
      }
      let msg = JSON.stringify(data);
      if (ws.readyState === WebSocket.OPEN) 
      {
        ws.send(msg);
      } 
      else 
      {
        alert("Connection is not open. Please refresh or try again later.");
      }
    }
    createGameButton.addEventListener('click', () => 
    {
      createGame();
    });

    joinGameButton.addEventListener('click', () => 
    {
      joinGame();
    });
    //send("create_game");
  </script>
</body>

</html>
